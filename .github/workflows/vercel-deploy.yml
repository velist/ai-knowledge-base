name: Verceléƒ¨ç½²å’ŒéªŒè¯

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: éƒ¨ç½²åˆ°Vercel
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…Pythonä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-vercel.txt
        
    - name: ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        # æ£€æŸ¥Pythonè¯­æ³•
        python -m py_compile api/index.py
        python -m py_compile api/admin.py
        echo "âœ… Pythonè¯­æ³•æ£€æŸ¥é€šè¿‡"
        
    - name: å®‰è£…Vercel CLI
      run: npm i -g vercel@latest
      
    - name: æ‹‰å–Vercelç¯å¢ƒä¿¡æ¯
      run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: æ„å»ºé¡¹ç›®
      run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      
    - name: éƒ¨ç½²åˆ°Vercel (é¢„è§ˆ)
      if: github.event_name == 'pull_request'
      id: deploy-preview
      run: |
        DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
        echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        echo "ğŸš€ é¢„è§ˆéƒ¨ç½²å®Œæˆ: $DEPLOYMENT_URL"
        
    - name: éƒ¨ç½²åˆ°Vercel (ç”Ÿäº§)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      id: deploy-production
      run: |
        DEPLOYMENT_URL=$(vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
        echo "deployment_url=$DEPLOYMENT_URL" >> $GITHUB_OUTPUT
        echo "ğŸš€ ç”Ÿäº§éƒ¨ç½²å®Œæˆ: $DEPLOYMENT_URL"
        
    - name: ç­‰å¾…éƒ¨ç½²å®Œæˆ
      run: |
        echo "â³ ç­‰å¾…éƒ¨ç½²å®Œå…¨å¯åŠ¨..."
        sleep 30
        
    - name: éªŒè¯éƒ¨ç½² (é¢„è§ˆ)
      if: github.event_name == 'pull_request'
      run: |
        DEPLOYMENT_URL="${{ steps.deploy-preview.outputs.deployment_url }}"
        echo "ğŸ” éªŒè¯é¢„è§ˆéƒ¨ç½²: $DEPLOYMENT_URL"
        python verify_deployment.py --url "$DEPLOYMENT_URL" --output verification-preview.json
        
    - name: éªŒè¯éƒ¨ç½² (ç”Ÿäº§)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        DEPLOYMENT_URL="${{ steps.deploy-production.outputs.deployment_url }}"
        echo "ğŸ” éªŒè¯ç”Ÿäº§éƒ¨ç½²: $DEPLOYMENT_URL"
        python verify_deployment.py --url "$DEPLOYMENT_URL" --output verification-production.json
        
    - name: ä¸Šä¼ éªŒè¯ç»“æœ
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: verification-results
        path: verification-*.json
        
    - name: è¯„è®ºPR (é¢„è§ˆéƒ¨ç½²)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const deploymentUrl = '${{ steps.deploy-preview.outputs.deployment_url }}';
          
          let verificationStatus = 'âœ… éªŒè¯é€šè¿‡';
          try {
            const verificationResult = JSON.parse(fs.readFileSync('verification-preview.json', 'utf8'));
            if (verificationResult.overall_status !== 'success') {
              verificationStatus = 'âš ï¸ éƒ¨åˆ†éªŒè¯å¤±è´¥';
            }
          } catch (e) {
            verificationStatus = 'âŒ éªŒè¯å¤±è´¥';
          }
          
          const comment = `## ğŸš€ Vercelé¢„è§ˆéƒ¨ç½²
          
          **éƒ¨ç½²çŠ¶æ€**: ${verificationStatus}
          **é¢„è§ˆåœ°å€**: ${deploymentUrl}
          **ç®¡ç†åå°**: ${deploymentUrl}/admin
          
          ### ğŸ” æµ‹è¯•è´¦æˆ·
          - ç”¨æˆ·å: \`vee5208\`
          - å¯†ç : \`forxy131\`
          
          ### ğŸ“‹ éªŒè¯é¡¹ç›®
          - âœ… å‰ç«¯æœåŠ¡
          - âœ… ç®¡ç†åå°
          - âœ… APIæ¥å£
          - âœ… å¥åº·æ£€æŸ¥
          
          ---
          *æ­¤è¯„è®ºç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: å‘é€éƒ¨ç½²é€šçŸ¥ (ç”Ÿäº§)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      run: |
        DEPLOYMENT_URL="${{ steps.deploy-production.outputs.deployment_url }}"
        echo "ğŸ“¢ ç”Ÿäº§éƒ¨ç½²é€šçŸ¥"
        echo "ğŸŒ å‰ç«¯åœ°å€: $DEPLOYMENT_URL"
        echo "ğŸ”§ ç®¡ç†åå°: $DEPLOYMENT_URL/admin"
        echo "ğŸ“š APIæ–‡æ¡£: $DEPLOYMENT_URL/docs"
        echo "ğŸ” ç®¡ç†å‘˜: vee5208 / forxy131"
        
  security-scan:
    runs-on: ubuntu-latest
    name: å®‰å…¨æ‰«æ
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: å®‰è£…å®‰å…¨æ‰«æå·¥å…·
      run: |
        pip install bandit safety
        
    - name: è¿è¡ŒBanditå®‰å…¨æ‰«æ
      run: |
        bandit -r api/ -f json -o bandit-report.json || true
        bandit -r api/ || true
        
    - name: æ£€æŸ¥ä¾èµ–å®‰å…¨æ€§
      run: |
        safety check --json --output safety-report.json || true
        safety check || true
        
    - name: ä¸Šä¼ å®‰å…¨æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          
  performance-test:
    runs-on: ubuntu-latest
    name: æ€§èƒ½æµ‹è¯•
    needs: deploy
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: å®‰è£…æ€§èƒ½æµ‹è¯•å·¥å…·
      run: |
        sudo apt-get update
        sudo apt-get install -y apache2-utils
        
    - name: è¿è¡Œæ€§èƒ½æµ‹è¯•
      run: |
        # è·å–éƒ¨ç½²URLï¼ˆè¿™é‡Œéœ€è¦ä»å‰é¢çš„jobè·å–ï¼‰
        DEPLOYMENT_URL="https://ai-knowledge-base.vercel.app"
        
        echo "ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•: $DEPLOYMENT_URL"
        
        # æµ‹è¯•é¦–é¡µå“åº”æ—¶é—´
        echo "ğŸ“Š æµ‹è¯•é¦–é¡µæ€§èƒ½..."
        ab -n 100 -c 10 "$DEPLOYMENT_URL/" > performance-home.txt || true
        
        # æµ‹è¯•APIæ€§èƒ½
        echo "ğŸ“Š æµ‹è¯•APIæ€§èƒ½..."
        ab -n 50 -c 5 "$DEPLOYMENT_URL/api/health" > performance-api.txt || true
        
        # æ˜¾ç¤ºç»“æœæ‘˜è¦
        echo "ğŸ“ˆ æ€§èƒ½æµ‹è¯•å®Œæˆ"
        grep "Requests per second" performance-*.txt || true
        grep "Time per request" performance-*.txt || true
        
    - name: ä¸Šä¼ æ€§èƒ½æŠ¥å‘Š
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: performance-reports
        path: performance-*.txt